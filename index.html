<?php
$title = "LunarTrev";
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><?= $title ?></title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg-primary:#05070a;
  --accent-moon:#f0f2ff;
  --accent-nebula:#a5b4fc;
  --text-muted:#848bbd;
  --glass-bg:rgba(13,19,45,.75);
  --glass-border:rgba(207,216,255,.15);
  --online-glow:#00ff88;
}

body{
  margin:0;font-family:Poppins,sans-serif;
  background:var(--bg-primary);color:#e8ebff;
  min-height:100vh;overflow-x:hidden;
}

.card{
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);
  border-radius:28px;
  padding:1.5rem;
  margin-bottom:1.2rem;
}

.avatar{
  width:48px;height:48px;border-radius:50%;
  border:2px solid var(--glass-border);
}

textarea,input{
  width:100%;padding:1rem;border-radius:12px;
  background:rgba(0,0,0,.3);
  border:1px solid var(--glass-border);
  color:#fff;font-family:inherit;
}

.button{
  width:100%;padding:1rem;border-radius:12px;
  border:none;background:var(--accent-moon);
  font-weight:700;cursor:pointer;
}

.nav-bar{
  position:fixed;bottom:25px;left:50%;
  transform:translateX(-50%);
  width:85%;max-width:380px;
  background:rgba(10,15,30,.85);
  border-radius:22px;
  display:flex;justify-content:space-around;
  padding:12px;z-index:100;
}

.nav-item{
  font-size:.7rem;opacity:.6;cursor:pointer;
}
.nav-item.active{opacity:1;font-weight:700}

.pulse-btn{
  background:none;border:1px solid var(--glass-border);
  color:var(--accent-nebula);
  padding:6px 16px;border-radius:20px;
  cursor:pointer;font-size:.8rem;
}
.pulse-btn.active{
  background:var(--accent-moon);
  color:var(--bg-primary);
}

.hidden{display:none}
.edit-box{margin-top:8px;min-height:80px}
</style>
</head>

<body>

<main style="max-width:500px;margin:auto;padding:1.5rem 1.5rem 8rem">

<!-- AUTH -->
<div id="auth-view" class="card">
<h2>LUNARTREV</h2>
<form id="auth-form">
<input id="reg-username" placeholder="Pilot Username" required>
<input id="email" type="email" placeholder="Earth Email" required>
<input id="password" type="password" placeholder="Security Key" required>
<button class="button">Access System</button>
</form>
</div>

<!-- HOME -->
<div id="home-tab" class="hidden">
<div class="card">
<textarea id="post-content" placeholder="Broadcast to the sector..." rows="3"></textarea>
<button id="send-btn" class="button">Transmit</button>
</div>
<div id="lunar-feed"></div>
</div>

</main>

<nav class="nav-bar hidden" id="main-nav">
<div class="nav-item active" data-tab="home-tab">Feed</div>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCGTSiMcNQaAVjkEI_9YRbb2C4CTvqQWEM",
  authDomain:"lunartrev.firebaseapp.com",
  projectId:"lunartrev"
});

const auth = getAuth(app);
const db = getFirestore(app);

/* AUTH */
document.getElementById("auth-form").onsubmit = async e=>{
e.preventDefault();
const email=email.value,password=password.value,user=reg-username.value;
try{
const u=await createUserWithEmailAndPassword(auth,email,password);
await setDoc(doc(db,"users",u.user.uid),{
username:user,profile_Image:`https://api.dicebear.com/7.x/bottts/svg?seed=${user}`
});
}catch(err){
if(err.code==="auth/email-already-in-use")
await signInWithEmailAndPassword(auth,email,password);
}
};

/* POST */
send-btn.onclick=async()=>{
const text=post-content.value.trim();
if(!text||!auth.currentUser)return;
const u=await getDoc(doc(db,"users",auth.currentUser.uid));
await addDoc(collection(db,"posts"),{
text,
authorId:auth.currentUser.uid,
authorName:u.data().username,
authorImg:u.data().profile_Image,
likes:[],
timestamp:serverTimestamp()
});
post-content.value="";
};

/* FEED */
onSnapshot(query(collection(db,"posts"),orderBy("timestamp","desc")),snap=>{
lunar-feed.innerHTML="";
snap.forEach(d=>{
const p=d.data();
const isAuthor=p.authorId===auth.currentUser?.uid;
const isLiked=p.likes?.includes(auth.currentUser?.uid);
const card=document.createElement("div");
card.className="card";

card.innerHTML=`
<div style="display:flex;gap:12px">
<img class="avatar" src="${p.authorImg}">
<div>
<b>${p.authorName}</b><br>
<small>${p.timestamp?.toDate().toLocaleTimeString()||""}</small>
</div>
</div>

<div class="post-text">${p.text}</div>
<textarea class="edit-box hidden">${p.text}</textarea>

<div style="margin-top:10px;display:flex;gap:10px">
<button class="pulse-btn ${isLiked?"active":""}">Pulse (${p.likes?.length||0})</button>
${isAuthor?`<button class="pulse-btn edit-btn">Edit</button>`:""}
</div>`;

card.querySelector(".pulse-btn").onclick=()=>{
updateDoc(doc(db,"posts",d.id),{
likes:isLiked?arrayRemove(auth.currentUser.uid):arrayUnion(auth.currentUser.uid)
});
};

if(isAuthor){
const btn=card.querySelector(".edit-btn");
const text=card.querySelector(".post-text");
const box=card.querySelector(".edit-box");

btn.onclick=async()=>{
if(!box.classList.contains("hidden")){
await updateDoc(doc(db,"posts",d.id),{text:box.value});
btn.innerText="Edit";
}else btn.innerText="Save";
text.classList.toggle("hidden");
box.classList.toggle("hidden");
};
}

lunar-feed.appendChild(card);
});
});

/* AUTH STATE */
onAuthStateChanged(auth,u=>{
if(u){
auth-view.classList.add("hidden");
home-tab.classList.remove("hidden");
main-nav.classList.remove("hidden");
}else{
auth-view.classList.remove("hidden");
home-tab.classList.add("hidden");
main-nav.classList.add("hidden");
}
});
</script>
</body>
</html>
