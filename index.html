<?php $title="LunarTrev"; ?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><?= $title ?></title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
--bg:#05070a;--moon:#f0f2ff;--neb:#a5b4fc;
--glass:rgba(13,19,45,.75);--border:rgba(207,216,255,.15)
}
body{margin:0;font-family:Poppins;background:var(--bg);color:#fff}
.hidden{display:none}
.card{background:var(--glass);border:1px solid var(--border);
border-radius:22px;padding:1.2rem;margin-bottom:1rem}
.avatar{width:48px;height:48px;border-radius:50%}
textarea,input{width:100%;padding:.8rem;border-radius:12px;
background:rgba(0,0,0,.3);border:1px solid var(--border);color:#fff}
.button{padding:.8rem;width:100%;border:none;border-radius:12px;
background:var(--moon);font-weight:700}
.nav{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
background:rgba(10,15,30,.85);display:flex;gap:25px;
padding:12px 24px;border-radius:20px}
.nav div{opacity:.6;cursor:pointer}
.nav .active{opacity:1;font-weight:700}
.msg{padding:.6rem .8rem;border-radius:14px;margin:.3rem 0}
.me{background:var(--moon);color:#000;align-self:flex-end}
.them{background:#1c244d}
</style>
</head>

<body>
<main style="max-width:480px;margin:auto;padding:1.2rem 1.2rem 7rem">

<!-- AUTH -->
<div id="auth" class="card">
<h2>LUNARTREV</h2>
<form id="authForm">
<input id="u" placeholder="Username" required>
<input id="e" type="email" placeholder="Email" required>
<input id="p" type="password" placeholder="Password" required>
<button class="button">Enter</button>
</form>
</div>

<!-- FEED -->
<div id="feed" class="hidden">
<div class="card">
<textarea id="postText" placeholder="Broadcast..."></textarea>
<button id="postBtn" class="button">Transmit</button>
</div>
<div id="posts"></div>
</div>

<!-- MESSAGES -->
<div id="messages" class="hidden">
<h3>Direct Signals</h3>
<div id="userList"></div>
<hr>
<div id="chatBox" class="hidden">
<div id="chatLog" style="display:flex;flex-direction:column"></div>
<textarea id="msgInput" placeholder="Type signal..."></textarea>
<button id="sendMsg" class="button">Send</button>
</div>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden">
<div class="card" style="text-align:center">
<img id="pImg" class="avatar" style="width:90px;height:90px"><br><br>
<input id="pImgEdit" placeholder="Profile Image URL">
<textarea id="pBioEdit" placeholder="Bio"></textarea>
<p><b>Rank:</b> <span id="pRank"></span></p>
<button id="saveProfile" class="button">Save Profile</button>
</div>
</div>

</main>

<div class="nav hidden" id="nav">
<div data-tab="feed" class="active">Feed</div>
<div data-tab="messages">Messages</div>
<div data-tab="profile">Profile</div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import{getAuth,onAuthStateChanged,
createUserWithEmailAndPassword,signInWithEmailAndPassword}
from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc,updateDoc,
collection,addDoc,query,orderBy,onSnapshot,serverTimestamp}
from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app=initializeApp({
apiKey:"AIzaSyCGTSiMcNQaAVjkEI_9YRbb2C4CTvqQWEM",
authDomain:"lunartrev.firebaseapp.com",
projectId:"lunartrev"
});
const auth=getAuth(app),db=getFirestore(app);
let currentChat=null,me=null;

/* NAV */
nav.onclick=e=>{
if(!e.target.dataset.tab)return;
document.querySelectorAll(".nav div").forEach(d=>d.classList.remove("active"));
e.target.classList.add("active");
["feed","messages","profile"].forEach(t=>document.getElementById(t).classList.add("hidden"));
document.getElementById(e.target.dataset.tab).classList.remove("hidden");
};

/* AUTH */
authForm.onsubmit=async e=>{
e.preventDefault();
try{
const uCred=await createUserWithEmailAndPassword(auth,e.value,p.value);
await setDoc(doc(db,"users",uCred.user.uid),{
username:u.value,
bio:"Exploration log started.",
profile_Image:`https://api.dicebear.com/7.x/bottts/svg?seed=${u.value}`,
rank:1
});
}catch{
await signInWithEmailAndPassword(auth,e.value,p.value);
}
};

/* FEED */
postBtn.onclick=async()=>{
if(!postText.value)return;
await addDoc(collection(db,"posts"),{
text:postText.value,
author:me.uid,
name:me.username,
img:me.profile_Image,
time:serverTimestamp()
});
postText.value="";
};

onSnapshot(query(collection(db,"posts"),orderBy("time","desc")),s=>{
posts.innerHTML="";
s.forEach(d=>{
const p=d.data();
posts.innerHTML+=`
<div class="card">
<div style="display:flex;gap:10px">
<img class="avatar" src="${p.img}">
<b>${p.name}</b>
</div>
<p>${p.text}</p>
</div>`;
});
});

/* MESSAGING */
onSnapshot(collection(db,"users"),s=>{
userList.innerHTML="";
s.forEach(d=>{
if(d.id===auth.currentUser.uid)return;
userList.innerHTML+=`
<div class="card" onclick="startChat('${d.id}')">${d.data().username}</div>`;
});
});

window.startChat=uid=>{
currentChat=[auth.currentUser.uid,uid].sort().join("_");
chatBox.classList.remove("hidden");
onSnapshot(query(collection(db,"chats",currentChat,"messages"),orderBy("time")),s=>{
chatLog.innerHTML="";
s.forEach(m=>{
const msg=m.data();
chatLog.innerHTML+=`
<div class="msg ${msg.from===auth.currentUser.uid?"me":"them"}">
${msg.text}</div>`;
});
});
};

sendMsg.onclick=async()=>{
if(!msgInput.value)return;
await addDoc(collection(db,"chats",currentChat,"messages"),{
from:auth.currentUser.uid,
text:msgInput.value,
time:serverTimestamp()
});
msgInput.value="";
};

/* PROFILE */
saveProfile.onclick=async()=>{
await updateDoc(doc(db,"users",auth.currentUser.uid),{
bio:pBioEdit.value,
profile_Image:pImgEdit.value
});
};

/* AUTH STATE */
onAuthStateChanged(auth,async u=>{
if(!u)return;
const snap=await getDoc(doc(db,"users",u.uid));
me={uid:u.uid,...snap.data()};
auth.classList.add("hidden");
feed.classList.remove("hidden");
nav.classList.remove("hidden");
pImg.src=me.profile_Image;
pImgEdit.value=me.profile_Image;
pBioEdit.value=me.bio;
pRank.innerText=me.rank;
});
</script>
</body>
</html>
